
<!DOCTYPE html>
<html lang="de">

<head>
  <meta charset="UTF-8" />
  <title>Neues Passwort setzen – ConcertJournal</title>

  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      margin: 0;
      padding: clamp(1rem, 4vw, 2rem);
      background: #0f0f14;
      color: #ffffff;
      max-width: 480px;
      margin-inline: auto;
    }

    h1 {
      margin-top: 4rem;
      font-size: 1.6rem;
      text-align: center;
    }

    p {
      opacity: 0.8;
      line-height: 1.6;
      text-align: center;
      margin-top: 1rem;
    }

    form {
      margin-top: 2.5rem;
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    input {
      padding: 0.7rem 0.8rem;
      border-radius: 8px;
      border: 1px solid rgba(255, 255, 255, 0.25);
      background: #0f0f14;
      color: #ffffff;
      font-size: 1rem;
    }

    input::placeholder {
      color: rgba(255, 255, 255, 0.5);
    }

    button {
      margin-top: 1rem;
      padding: 0.75rem;
      border-radius: 10px;
      border: 1px solid rgba(255, 255, 255, 0.3);
      background: transparent;
      color: #ffffff;
      font-size: 1rem;
      cursor: pointer;
      min-height: 44px;
      transition: opacity 0.2s;
    }

    button:hover {
      opacity: 0.85;
    }

    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .message {
      margin-top: 1.5rem;
      font-size: 0.95rem;
      text-align: center;
      padding: 1rem;
      border-radius: 8px;
    }

    .error {
      color: #ff8a8a;
      background: rgba(255, 138, 138, 0.1);
    }

    .success {
      color: #9dd39d;
      background: rgba(157, 211, 157, 0.1);
    }

    .info {
      color: #8ab4ff;
      background: rgba(138, 180, 255, 0.1);
    }

    .debug {
      margin-top: 2rem;
      padding: 1rem;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 8px;
      font-size: 0.85rem;
      font-family: monospace;
      word-break: break-all;
      display: none;
    }

    .debug.show {
      display: block;
    }

    .loading {
      text-align: center;
      margin-top: 2rem;
    }

    .spinner {
      border: 3px solid rgba(255, 255, 255, 0.1);
      border-top: 3px solid #ffffff;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>

<body>

  <h1>Neues Passwort</h1>

  <p id="description">
    Bitte gib dein neues Passwort ein.
  </p>

  <div id="loading" class="loading" style="display: none;">
    <div class="spinner"></div>
    <p>Überprüfe Reset-Link...</p>
  </div>

  <form id="password-form" style="display: none;">
    <input type="password" id="password" placeholder="Neues Passwort" required minlength="6" />

    <input type="password" id="passwordConfirm" placeholder="Passwort bestätigen" required minlength="6" />

    <button type="submit" id="submit-btn">
      Passwort speichern
    </button>
  </form>

  <div id="message" class="message"></div>

  <!-- Debug Info (nur bei Entwicklung sichtbar) -->
  <div id="debug" class="debug">
    <strong>Debug Info:</strong><br>
    <span id="debug-content"></span>
  </div>

  <!-- Supabase -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script>
    // ====================================
    // KONFIGURATION
    // ====================================
    const SUPABASE_URL = "https://brjekjxckpdlwffcdndn.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJyamVranhja3BkbHdmZmNkbmRuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzQ2MTQzMjAsImV4cCI6MjA1MDE5MDMyMH0.dGZSZOo71oaLZ2yk_2y75xNV_aYg8d95o0BQKgPPVnE";
    
    // Debug Mode aktivieren (in Produktion auf false setzen)
    const DEBUG_MODE = true;

    // ====================================
    // INITIALISIERUNG
    // ====================================
    const client = window.supabase.createClient(
      SUPABASE_URL,
      SUPABASE_ANON_KEY
    );

    const form = document.getElementById("password-form");
    const messageEl = document.getElementById("message");
    const loadingEl = document.getElementById("loading");
    const descriptionEl = document.getElementById("description");
    const submitBtn = document.getElementById("submit-btn");
    const debugEl = document.getElementById("debug");
    const debugContent = document.getElementById("debug-content");

    // ====================================
    // HELPER FUNKTIONEN
    // ====================================
    
    function showMessage(text, type = "info") {
      messageEl.textContent = text;
      messageEl.className = `message ${type}`;
    }

    function showDebug(info) {
      if (DEBUG_MODE) {
        debugContent.innerHTML += `${new Date().toLocaleTimeString()}: ${info}<br>`;
        debugEl.classList.add("show");
      }
    }

    function showLoading(show) {
      loadingEl.style.display = show ? "block" : "none";
      form.style.display = show ? "none" : "flex";
    }

    // ====================================
    // RECOVERY INITIALISIERUNG
    // ====================================
    
    async function initRecovery() {
      showLoading(true);
      showDebug("Starting password recovery...");
      
      const fullUrl = window.location.href;
      showDebug(`Current URL: ${fullUrl}`);

      // URL-Parameter parsen
      const urlParams = new URLSearchParams(window.location.search);
      const hashParams = new URLSearchParams(window.location.hash.substring(1));
      
      // Prüfe auf verschiedene Parameter-Formate
      const token = urlParams.get('token') || hashParams.get('token');
      const type = urlParams.get('type') || hashParams.get('type');
      const code = urlParams.get('code') || hashParams.get('code');
      
      showDebug(`Token: ${token ? 'Present' : 'Missing'}`);
      showDebug(`Type: ${type || 'Missing'}`);
      showDebug(`Code: ${code ? 'Present' : 'Missing'}`);

      // PKCE Flow (neuere Methode)
      if (code || fullUrl.includes('code=')) {
        showDebug("Attempting PKCE flow (exchangeCodeForSession)...");
        
        try {
          const { data, error } = await client.auth.exchangeCodeForSession(fullUrl);

          if (error) {
            showDebug(`PKCE Error: ${error.message}`);
            throw error;
          }

          if (data?.session) {
            showDebug("PKCE Success! Session created.");
            showSuccess();
            return;
          }
        } catch (err) {
          showDebug(`PKCE Exception: ${err.message}`);
          // Fallback zu legacy Flow
        }
      }

      // Legacy Flow (ältere Methode mit token + type)
      if (token && type === 'recovery') {
        showDebug("Attempting legacy flow (verifyOtp)...");
        
        try {
          const { data, error } = await client.auth.verifyOtp({
            token_hash: token,
            type: 'recovery'
          });

          if (error) {
            showDebug(`Legacy Error: ${error.message}`);
            throw error;
          }

          if (data?.session) {
            showDebug("Legacy Success! Session created.");
            showSuccess();
            return;
          }
        } catch (err) {
          showDebug(`Legacy Exception: ${err.message}`);
        }
      }

      // Hash Fragment Flow (für alte Links)
      if (window.location.hash.includes('access_token')) {
        showDebug("Attempting hash fragment flow...");
        
        try {
          const { data, error } = await client.auth.getSession();
          
          if (error) {
            showDebug(`Hash Error: ${error.message}`);
            throw error;
          }

          if (data?.session) {
            showDebug("Hash Success! Session found.");
            showSuccess();
            return;
          }
        } catch (err) {
          showDebug(`Hash Exception: ${err.message}`);
        }
      }

      // Wenn alle Methoden fehlschlagen
      showError();
    }

    function showSuccess() {
      showLoading(false);
      form.style.display = "flex";
      showDebug("Recovery successful - form shown");
    }

    function showError() {
      showLoading(false);
      descriptionEl.style.display = "none";
      
      showMessage(
        "Der Reset-Link ist ungültig oder abgelaufen. Bitte fordere einen neuen Link an.",
        "error"
      );
      
      showDebug("Recovery failed - all methods exhausted");
      
      // Optional: Zurück zur Login-Seite nach 5 Sekunden
      setTimeout(() => {
        const loginUrl = "concertjournal://"; // Deep Link zur App
        showMessage(
          `Zurück zur App... Falls nicht automatisch weitergeleitet wird, öffne die App manuell.`,
          "info"
        );
        window.location.href = loginUrl;
      }, 5000);
    }

    // ====================================
    // PASSWORT AKTUALISIERUNG
    // ====================================
    
    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      messageEl.textContent = "";
      messageEl.className = "message";
      submitBtn.disabled = true;
      submitBtn.textContent = "Wird gespeichert...";

      const password = document.getElementById("password").value;
      const confirm = document.getElementById("passwordConfirm").value;

      // Validierung
      if (password.length < 6) {
        showMessage(
          "Das Passwort muss mindestens 6 Zeichen lang sein.",
          "error"
        );
        submitBtn.disabled = false;
        submitBtn.textContent = "Passwort speichern";
        return;
      }

      if (password !== confirm) {
        showMessage(
          "Die Passwörter stimmen nicht überein.",
          "error"
        );
        submitBtn.disabled = false;
        submitBtn.textContent = "Passwort speichern";
        return;
      }

      // Passwort aktualisieren
      showDebug("Updating password...");
      
      const { data, error } = await client.auth.updateUser({
        password: password
      });

      if (error) {
        showDebug(`Update Error: ${error.message}`);
        showMessage(error.message, "error");
        submitBtn.disabled = false;
        submitBtn.textContent = "Passwort speichern";
        return;
      }

      showDebug("Password updated successfully!");
      showMessage(
        "✓ Passwort wurde erfolgreich geändert. Du wirst zur App weitergeleitet...",
        "success"
      );

      // Warte kurz und leite dann zur App weiter
      setTimeout(() => {
        // Deep Link zur App (öffnet die App)
        window.location.href = "concertjournal://";
        
        // Fallback nach 2 Sekunden falls Deep Link nicht funktioniert
        setTimeout(() => {
          showMessage(
            "Bitte öffne die ConcertJournal App manuell.",
            "info"
          );
        }, 2000);
      }, 1500);
    });

    // ====================================
    // START
    // ====================================
    
    // Initialisiere Recovery beim Laden der Seite
    initRecovery();
  </script>

</body>

</html>